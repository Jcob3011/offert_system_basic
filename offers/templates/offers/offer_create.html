{% load static %}
<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <div class="row align-items-center mb-5">
      <div class="col-3"></div>

      <div class="col-6 text-center">
        <h2 class="fw-bold text-primary mb-0">
          <i class="bi bi-magic"></i>
          {% if offer %} Edycja: {{ offer.offer_number }} {% else %} Nowa Oferta
          {% endif %}
        </h2>
      </div>
    </div>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="{% static 'css/offer_create.css' %}" />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <form method="post" enctype="multipart/form-data" id="offerForm">
        {% csrf_token %}

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold text-primary">
            <i class="bi bi-magic"></i> Kreator Oferty
          </h2>
          <div>
            <a
              href="{% url 'offer_list' %}"
              class="btn btn-outline-secondary me-2"
              >Anuluj</a
            >
            <button type="submit" class="btn btn-primary px-4 fw-bold">
              <i class="bi bi-save"></i> Zapisz Ofertę
            </button>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-dark text-white fw-bold">
                1. Dane Klienta
              </div>
              <div class="card-body">
                {% for field in form %}
                <div class="mb-3">
                  <label class="form-label small fw-bold text-muted"
                    >{{ field.label }}</label
                  >
                  {{ field }} {% if field.errors %}
                  <div class="text-danger small">{{ field.errors.0 }}</div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card shadow-sm border-0">
              <div
                class="card-header bg-white fw-bold border-bottom d-flex justify-content-between align-items-center"
              >
                <span>2. Pozycje Kosztorysu</span>
                <small class="text-muted">Dodaj usługi i produkty</small>
              </div>
              <div class="card-body p-0">
                {{ formset.management_form }}

                <table class="table table-hover mb-0 align-middle">
                  <thead class="bg-light text-secondary small text-uppercase">
                    <tr>
                      <th style="width: 50%" class="ps-3">Nazwa</th>
                      <th style="width: 15%">Ilość</th>
                      <th style="width: 20%">Cena jedn.</th>
                      <th style="width: 10%">Usuń</th>
                    </tr>
                  </thead>
                  <tbody id="items-container">
                    {% for item_form in formset %}
                    <tr class="item-row">
                      <td class="ps-3">
                        {% for hidden in item_form.hidden_fields %} {{ hidden }}
                        {% endfor %} {{ item_form.description }}
                      </td>
                      <td>{{ item_form.quantity }}</td>
                      <td>{{ item_form.price_per_unit }}</td>
                      <td class="text-center">
                        {% if formset.can_delete %}
                        <div class="form-check d-flex justify-content-center">
                          {{ item_form.DELETE }}
                        </div>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="card-footer bg-white text-center py-3">
                <button
                  type="button"
                  class="btn btn-success btn-sm px-4 rounded-pill"
                  id="add-item-btn"
                >
                  <i class="bi bi-plus-lg"></i> Dodaj kolejną pozycję
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const addBtn = document.getElementById("add-item-btn");
        const totalFormsInput = document.getElementById("id_items-TOTAL_FORMS");
        const container = document.getElementById("items-container");

        addBtn.addEventListener("click", function (e) {
          e.preventDefault();

       
          if (!totalFormsInput) {
            console.error(
              "Błąd: Nie znaleziono pola TOTAL_FORMS. Sprawdź czy w forms.py related_name matchuje prefix."
            );
         
            var fallbackInput = document.getElementById(
              "id_offeritem_set-TOTAL_FORMS"
            );
            if (fallbackInput) {
            
              console.log("Znaleziono stary prefix offeritem_set");
              fallbackLogic(fallbackInput, container);
              return;
            }
            return;
          }

          // Główna logika
          let formCount = parseInt(totalFormsInput.value);
          const templateRow = container.querySelectorAll(".item-row")[0];
          const newRow = templateRow.cloneNode(true);

          // Regex do zamiany indeksów 
          const regex = /-\d+-/g;
          const replacement = `-${formCount}-`;

          newRow.innerHTML = newRow.innerHTML.replace(regex, replacement);

          // Czyszczenie danych
          const inputs = newRow.querySelectorAll("input");
          inputs.forEach((input) => {
            input.value = "";
            if (input.type === "checkbox") input.checked = false;
          });

          container.appendChild(newRow);
          totalFormsInput.value = formCount + 1;
        });

        // Funkcja awaryjna 
        function fallbackLogic(totalInput, container) {
          let formCount = parseInt(totalInput.value);
          const row = container.querySelectorAll(".item-row")[0];
          const newRow = row.cloneNode(true);
          const regex = /-\d+-/g;
          newRow.innerHTML = newRow.innerHTML.replace(regex, `-${formCount}-`);
          newRow.querySelectorAll("input").forEach((i) => (i.value = ""));
          container.appendChild(newRow);
          totalInput.value = formCount + 1;
        }
      });
    </script>
  </body>
</html>
